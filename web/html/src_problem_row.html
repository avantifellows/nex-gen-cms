{{ range . }}
<tr class="border-b">
    <td class="p-2">{{.Code}}</td>
    <td class="p-2">{{.MetaData.Question}}</td>
    <td class="p-2 text-center"><button class="px-2 py-1 bg-green-500 text-white rounded" data-id="{{.ID}}"
            data-code="{{.Code}}" data-question="{{.MetaData.Question}}" data-subject="{{.Subject.ID}}"
            data-subtype="{{.Subtype}}" hx-on:click="addQuestionToTest(this)">+</button>
    </td>
</tr>

<script>
    function addQuestionToTest(btn) {
        const dataset = btn.dataset
        const subtype = dataset.subtype;
        const subjectId = dataset.subject;
        const questionsTableBody = document.querySelector("#questions-table-body");

        const subjectRows = questionsTableBody.querySelectorAll(`tr[data-subject="subject-${subjectId}"]`);
        const subtypeRows = questionsTableBody.querySelectorAll(`tr[data-subject="subject-${subjectId}"][data-subtype="subtype-${subtype}"]`);

        let insertAfterId = "";

        if (subtypeRows.length > 0) {
            // Subtype exists — insert after last row of this subtype
            insertAfterId = subtypeRows[subtypeRows.length - 1].id;
        } else if (subjectRows.length > 0) {
            // Subtype doesn't exist but subject does — insert after last subject-related row
            insertAfterId = subjectRows[subjectRows.length - 1].id;
        }

        htmx.ajax("POST", "/add-question-to-test", {
            target: btn.closest("tr"),
            swap: "delete",
            values: {
                "id": dataset.id,
                "code": dataset.code,
                "question": dataset.question,
                "subtype": subtype,
                "subject-id": subjectId,
                "subject-exists": subjectRows.length > 0,
                "subtype-exists": subtypeRows.length > 0,
                "insert-after-id": insertAfterId
            }
        });
    }
</script>
{{ end }}