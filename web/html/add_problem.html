{{ define "content" }}
<form class="mx-auto px-4 bg-white shadow-md" onsubmit="createProblem(event, {{.TopicPtr.ID}}, {{.TopicPtr.ChapterID}});">
    <h2 class="text-lg font-semibold mb-4">Add New Problem</h2>

    <!-- type, skills, concepts -->
    <div class="grid grid-cols-3 gap-6 mb-6">
        <div>
            <p class="font-semibold mb-2">Select Type:</p>
            <select id="problem-type-dropdown" name="problem-type-dropdown"
                class="w-full border border-gray-300 rounded p-2">
                {{ template "problem_type_options" }}
            </select>
        </div>
        <div>
            <p class="font-semibold mb-2">Select Skills:</p>
            <select id="skills-dropdown" name="skills-dropdown" multiple hx-trigger="load"
                class="w-full border border-gray-300 rounded p-2 h-20 overflow-y-auto" hx-get="/api/skills">
                <option disabled>Loading skills...</option>
            </select>
        </div>
        <div>
            <p class="font-semibold mb-2">Select Concepts:</p>
            <select id="concepts-dropdown" name="concepts-dropdown" multiple hx-trigger="load"
                class="w-full border border-gray-300 rounded p-2 h-20 overflow-y-auto"
                hx-get="/api/concepts?topic_id={{.TopicPtr.ID}}">
                <option disabled>Loading concepts...</option>
            </select>
            <a href="#" class="text-blue-600 underline">Add Concept from other topic</a>
        </div>
    </div>

    <!-- difficulty -->
    <div class="mb-6">
        <p class="font-semibold mb-2">Difficulty Rating</p>
        <label class="mr-4"><input type="radio" name="difficulty" value="easy"> 1</label>
        <label class="mr-4"><input type="radio" name="difficulty" value="medium"> 2</label>
        <label class="mr-4"><input type="radio" name="difficulty" value="hard"> 3</label>
    </div>

    <!-- Question editor -->
    <div id="questionDiv" class="mb-6">
        <p class="font-semibold mb-2">Text:</p>
        {{ template "editor" . }}
    </div>

    <!-- Options -->
    <div id="optionsDiv" class="mb-6">
        <p class="font-semibold mb-2">Options:</p>
        <!-- MCQ Option Tabs -->
        <div id="optionTabs" class="flex items-center overflow-x-auto">
            <!-- Tabs will be inserted before this -->
            <!-- Add (+) Tab -->
            <!-- type="button" is added to prevent it from invoking form submit action (due to form's 
             internal button's default type="submit") -->
            <button id="addTab" type="button" title="Add Option" class="mcq-tab-add">+</button>
        </div>

        <!-- Shared Editor -->
        {{ template "editor" . }}
    </div>

    <!-- Answer -->
    <div class="mb-6" id="answerDiv">
        <p class="font-semibold mb-2">Answer:</p>
        <!-- Checkboxes will be generated dynamically -->
    </div>

    <!-- Solution -->
    <div class="mb-6" id="solutionDiv">
        <p class="font-semibold mb-2">Solution:</p>
        {{ template "editor" . }}
    </div>

    <!-- Tags -->
    <div class="mb-6">
        <p class="font-semibold mb-2">Tags:</p>
        {{ template "input_tags" . }}
    </div>

    <!-- SOURCE -->
    <!-- <div class="mb-6">
        <p class="font-semibold mb-2">SOURCE</p>
        <table class="w-full text-left border border-gray-300">
            <thead class="bg-gray-200">
                <tr>
                    <th class="px-4 py-2">Name</th>
                    <th class="px-4 py-2">Mode</th>
                    <th class="px-4 py-2">Year</th>
                    <th class="px-4 py-2">Description</th>
                    <th class="px-4 py-2">Action</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="px-4 py-2" colspan="5" align="center">No Source Added</td>
                </tr>
            </tbody>
        </table>
        <a href="#" class="text-blue-600 underline mt-2 inline-block">Add Source</a>
    </div> -->

    <!-- Save button -->
    <button type="submit"
        class="w-full bg-blue-500 text-white mb-4 py-3 font-semibold rounded hover:bg-blue-600">Save</button>
</form>
<script src="/web/static/js/editor.js"></script>
<script>
    (() => {
        const optionsDiv = document.getElementById('optionsDiv');
        const optionTabs = optionsDiv.querySelector('#optionTabs');
        const addTabButton = optionsDiv.querySelector('#addTab');

        const labelPool = 'ABCDEFGHIJ';
        let tabs = new Array(4).fill(null); // Start with 4 tabs
        let activeIndex = 0;

        const tabContent = []; // Each entry: { html: '...', preview: '...' }

        const editor = optionsDiv.querySelector('.editor');
        const preview = optionsDiv.querySelector('.output');

        const answers = new Set(); // <=== tracks checked answer labels

        function getLabel(index) {
            return labelPool[index];
        }

        function renderTabs() {
            // Clear old tabs
            document.querySelectorAll('.mcq-tab').forEach(tab => tab.remove());
            // Remove old checkboxes
            const answerDiv = document.getElementById('answerDiv');
            answerDiv.querySelectorAll('label').forEach(label => label.remove());

            tabs.forEach((_, index) => {
                const label = getLabel(index);

                // Create option tab
                const tab = document.createElement('div');
                tab.className = 'mcq-tab' + (index === activeIndex ? ' active' : '');
                tab.dataset.index = index;
                tab.innerHTML = `
                    <span class="mr-2">${label}</span>
                    <button title="Remove" class="remove-btn">&times;</button>
                `;
                tab.addEventListener('click', () => {
                    if (index === activeIndex) return;
                    saveCurrentContent();
                    setActiveTab(index)
                });
                tab.querySelector('.remove-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    saveCurrentContent();
                    removeTab(index);
                });
                optionTabs.insertBefore(tab, addTabButton);

                // Create answer checkbox
                const checkboxLabel = document.createElement('label');
                checkboxLabel.className = 'mr-4';
                checkboxLabel.innerHTML = `<input type="checkbox" name="answer" value="${label}"> ${label}`;

                const checkbox = checkboxLabel.querySelector('input');
                // restore checked state if present
                checkbox.checked = answers.has(label);

                // update answers set on change
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        answers.add(label);
                    } else {
                        answers.delete(label);
                    }
                });

                answerDiv.appendChild(checkboxLabel);
            });

            // Hide "+" button if 10 or more tabs
            addTabButton.style.display = tabs.length >= 10 ? 'none' : 'flex';
        }

        function saveCurrentContent() {
            tabContent[activeIndex] = {
                html: editor.innerHTML,
                preview: preview.innerHTML
            };
        }

        function setActiveTab(index) {
            activeIndex = index;
            document.querySelectorAll('.mcq-tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });

            // Load saved content
            loadActiveContent();
        }

        function addTab() {
            if (tabs.length >= labelPool.length) return;

            saveCurrentContent(); // Save current tab before adding new

            tabs.push(null);
            tabContent.push({ html: '', preview: '' });
            activeIndex = tabs.length - 1;

            renderTabs();
            editor.innerHTML = '';
            preview.innerHTML = '';
        }

        function removeTab(index) {
            if (tabs.length <= 1) {
                alert("At least one tab must remain.");
                return;
            }

            tabs.splice(index, 1);
            tabContent.splice(index, 1);

            const removedLabel = getLabel(index); // label like 'A', 'B'
            // Also remove this label from answers set
            answers.delete(removedLabel);

            if (activeIndex >= tabs.length) {
                activeIndex = tabs.length - 1;
            }
            renderTabs();

            // Load new active content
            loadActiveContent();
        }

        function loadActiveContent() {
            const content = tabContent[activeIndex] || { html: '', preview: '' };
            editor.innerHTML = content.html;
            preview.innerHTML = content.preview;
        }

        addTabButton.addEventListener('click', addTab);

        // Initial setup
        tabs.forEach(() => tabContent.push({ html: '', preview: '' }));
        // Initial render
        renderTabs();
        setActiveTab(0);

        window.createProblem = function (event, topicId, chapterId) {
            event.preventDefault();  // Cancel the default form request
            // save latest option value visible; otherwise if save is pressed directly after entering value
            // in option A editor, it will show wrong alert aking to enter value in option A, because without
            // this save call we are saving tab content only on switching tabs and adding new tab
            saveCurrentContent();

            if (!validateFields()) {
                return false;
            }

            const prolemJson = buildProblemJson(topicId, chapterId);
            const url = '/create-problem';
            const method = 'POST';

            fetch(url, {
                method: method,
                body: JSON.stringify(prolemJson),
                headers: {
                    'Content-Type': 'application/json',  // Specify content type as JSON
                    'HX-Request': 'true'  // so that your server can detect HTMX if needed
                }

            }).then(res => {
                if (!res.ok) {
                    // Turn HTTP error into a real JS error to trigger .catch
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.text(); // if OK, read body

            }).then(html => {
                // go back to remove add/edit problem screen
                goBackAfterDelay(0);

            }).catch(err => {
                console.error("Error during prolem creation:", err);
            });
        };

        function validateFields() {
            const difficulty = document.querySelector('input[name="difficulty"]:checked');
            if (!difficulty) {
                alert('Please select a difficulty level.');
                return;
            }
            const editor = document.getElementById('questionDiv').querySelector('.editor');
            if (!editor.textContent.trim()) {
                alert('Please enter the question.');
                return;
            }

            if (typeof tabContent !== 'undefined' && Array.isArray(tabContent)) {
                for (let i = 0; i < tabContent.length; i++) {
                    const optionLabel = String.fromCharCode(65 + i); // A, B, C...
                    const optionText = tabContent[i]?.html?.trim();
                    if (!optionText) {
                        alert(`Option ${optionLabel} is empty. Please fill it out before submitting.`);
                        return false;
                    }
                }
            } else {
                alert('Options are not available.');
                return false;
            }

            if (answers.size === 0) {
                alert('Please select at least one answer.');
                return false;
            }
            return true;
        }

        function buildProblemJson(topicId, chapterId) {
            const subtype = document.getElementById('problem-type-dropdown').value;

            const skillsDropdown = document.getElementById("skills-dropdown");
            const selectedSkillIds = Array.from(skillsDropdown.selectedOptions).map(opt => parseInt(opt.value, 10));

            const curriculumId = parseInt(document.getElementById("curriculum-dropdown").value);
            const gradeId = parseInt(document.getElementById("grade-dropdown").value);
            const subjectId = parseInt(document.getElementById("subject-dropdown").value);

            const difficulty = document.querySelector('input[name="difficulty"]:checked').value;

            const question = document.getElementById('questionDiv').querySelector('.editor').innerHTML;
            const options = tabContent.map(item => item.html);
            // Convert the labels to their number indexes (+1), and then to strings
            const answerNumbers = Array.from(answers).map(label => {
                const index = labelPool.indexOf(label);
                return (index + 1).toString();
            });
            const solution = document.getElementById('solutionDiv').querySelector('.editor').innerHTML;

            const conceptsDropdown = document.getElementById("concepts-dropdown");
            const selectedConceptIds = Array.from(conceptsDropdown.selectedOptions).map(opt => parseInt(opt.value, 10));

            return {
                type: "problem",
                subtype: subtype,
                skill_ids: selectedSkillIds,
                type_params: {
                    test_ids: []
                },
                curriculum_id: curriculumId,
                grade_id: gradeId,
                subject_id: subjectId,
                topic_id: topicId,
                chapter_id: chapterId,
                difficulty_level: difficulty,
                meta_data: {
                    text: question,
                    options: options,
                    answer: answerNumbers,
                    solutions: [
                        {
                            type: "text",
                            value: solution
                        }
                    ]
                },
                concept_ids: selectedConceptIds,
                tags: window.getProblemTags()
            };
        }
    })();
</script>
{{ end }}