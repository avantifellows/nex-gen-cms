{{ define "content" }}
<div hx-ext="table-sort" data-sort-scope="tests">
    <div class="flex justify-between items-center mb-4">

        <!-- Left side: Test type dropdown + Search -->
        <div class="flex items-center space-x-4">

            <!-- hx-trigger="onLoaded from:(#curriculum-dropdown, #grade-dropdown)" is added to load tests on 
            coming back from single test to tests list screen -->
            <select id="testtype-dropdown" hx-ext="testsLoader" name="testtype-dropdown"
                class="border border-gray-400 p-2 rounded" hx-get="/api/tests"
                hx-trigger="change, change from:(#curriculum-dropdown, #grade-dropdown), onLoaded from:(#curriculum-dropdown, #grade-dropdown)"
                hx-target="#testTableBody" hx-include="#curriculum-dropdown, #grade-dropdown, #testtype-dropdown"
                onchange="sessionStorage.setItem('selectedTesttype', this.value); sessionStorage.setItem(window.TESTS_LOADED_KEY, 'false');"
                hx-on::after-request="sessionStorage.setItem(window.TESTS_LOADED_KEY, 'true')">
                {{ template "test_type_options" }}
            </select>

            <!-- Search field -->
            <input type="text" id="test-search" name="search" placeholder="Search tests by code or name..."
                class="border border-gray-400 p-2 rounded w-64" hx-get="/api/tests"
                hx-trigger="keyup changed delay:500ms" hx-target="#testTableBody">

        </div>

        <!-- Add New Test Link -->
        <h4 class="text-sm font-semibold text-blue-500 hover:underline ml-4">
            <a href="#" 
                hx-get="/tests/add-test-dialog" 
                hx-target="body" 
                hx-push-url="true"
                hx-swap="beforeend">Add New Test</a>
        </h4>
    </div>

    <!-- Content Area -->
    <div id="subcontent">
        <div class="shadow-md my-6 overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead>
                    <tr class="bg-gray-200 text-gray-600 text-sm">
                        <th class="py-4 px-6 text-left">
                            <a href="#" hx-get="/tests" hx-target="body" hx-on:click="updateTableSortState('1', 'tests');">
                                Code <i class="fas fa-sort"></i>
                            </a>
                        </th>
                        <th class="px-6 text-left">
                            <a href="#" hx-get="/tests" hx-target="body" hx-on:click="updateTableSortState('2', 'tests');">
                                Name <i class="fas fa-sort"></i>
                            </a>
                        </th>
                        <th class="px-6 text-center">
                            <a href="#" hx-get="/tests" hx-target="body" hx-on:click="updateTableSortState('3', 'tests');">
                                # of questions <i class="fas fa-sort"></i>
                            </a>
                        </th>
                        <th class="px-6 text-center">
                            <a href="#" hx-get="/tests" hx-target="body" hx-on:click="updateTableSortState('4', 'tests');">
                                Marks <i class="fas fa-sort"></i>
                            </a>
                        </th>
                        <th class="px-6 text-center">
                            <a href="#" hx-get="/tests" hx-target="body" hx-on:click="updateTableSortState('5', 'tests');">
                                Duration <i class="fas fa-sort"></i>
                            </a>
                        </th>
                        <th class="px-6 text-center">
                            <a href="#" hx-get="/tests" hx-target="body" hx-on:click="updateTableSortState('6', 'tests');">
                                Set <i class="fas fa-sort"></i>
                            </a>
                        </th>
                        <th class="px-6 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="testTableBody" class="text-gray-600 text-sm">
                    <!-- Rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    (function () {
        htmx.defineExtension('testsLoader', {
            onEvent: function (name, event) {
                if (name === "htmx:afterProcessNode") {
                    restoreState();

                } else if (name === "htmx:beforeRequest") {
                    const requestPath = event.detail.elt.getAttribute("hx-get");

                    if (requestPath === "/api/tests") {
                        if (sessionStorage.getItem(window.TESTS_LOADED_KEY) === "true") {
                            console.log("Skipping /api/tests request because tests are already loaded.");
                            event.preventDefault();

                        } else {
                            const params = event.detail.requestConfig.parameters;
                            const curriculum = params["curriculum-dropdown"];
                            const grade = params["grade-dropdown"];

                            // if dropdown values are showing default value like "Loading...", then don't execute request
                            if (!isInt(curriculum) || !isInt(grade)) {
                                console.log("Skipping /api/tests request because dropdowns are not loaded yet.");
                                event.preventDefault();

                            } else {
                                const storedCurriculum = sessionStorage.getItem("selectedCurriculum");
                                const storedGrade = sessionStorage.getItem("selectedGrade");

                                if ((storedCurriculum && storedCurriculum !== curriculum) ||
                                    (storedGrade && storedGrade !== grade)) {
                                    // at least 1 dropdown value is 1 (1st item value) and its correct value is yet to be retained from sessionStorage
                                    console.log("Skipping /api/tests request because dropdowns values are not yet retained.");
                                    event.preventDefault();
                                }
                            }
                        }
                    }
                }
            }
        });

        function restoreState() {
            const dropdown = document.getElementById('testtype-dropdown');
            if (!dropdown) return;

            const storedTesttype = sessionStorage.getItem('selectedTesttype');

            if (storedTesttype && dropdown.value !== storedTesttype) {
                dropdown.value = storedTesttype;

                // Trigger native change event so HTMX picks it up
                htmx.trigger(dropdown, 'change');
            }
        }
    })();
</script>
{{ end }}