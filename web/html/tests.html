<div>
    <select id="testtype-dropdown" name="testtype-dropdown" class="border border-gray-400 p-2 rounded"
        hx-get="/api/tests" hx-trigger="change, change from:(#curriculum-dropdown, #grade-dropdown)"
        hx-target="#testTableBody" hx-include="#curriculum-dropdown, #grade-dropdown, #testtype-dropdown"
        onchange="sessionStorage.setItem('selectedTesttype', this.value)">
        <option value="">-- Select --</option>
        <option value="chapter_test">Chapter Test</option>
        <option value="part_test">Part Test</option>
        <option value="major_test">Major Test</option>
        <option value="full_syllabus_test">Full Syllabus Test</option>
        <option value="evaluation_test">Evaluation Test</option>
        <option value="mock_test">Mock Test</option>
        <option value="nta_test">NTA Test</option>
        <option value="homework_assignment">Homework Assignment</option>
    </select>

    <!-- Content Area -->
    <div id="subcontent">
        <div class="shadow-md my-6 overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead>
                    <tr class="bg-gray-200 text-gray-600 text-sm">
                        <th class="py-4 px-6 text-left">
                            <a href="#" hx-get="/tests" hx-target="#content" hx-on:click="updateSortState(event, '1')">
                                Code <i class="fas fa-sort"></i>
                            </a>
                        </th>
                        <th class="px-6 text-left">
                            <a href="#" hx-get="/tests" hx-target="#content" hx-on:click="updateSortState(event, '2')">
                                Name <i class="fas fa-sort"></i>
                            </a>
                        </th>
                        <th class="px-6 text-center">
                            <a href="#" hx-get="/tests" hx-target="#content" hx-on:click="updateSortState(event, '3')">
                                # of questions <i class="fas fa-sort"></i>
                            </a>
                        </th>
                        <th class="px-6 text-center">
                            <a href="#" hx-get="/tests" hx-target="#content" hx-on:click="updateSortState(event, '4')">
                                Marks <i class="fas fa-sort"></i>
                            </a>
                        </th>
                        <th class="px-6 text-center">
                            <a href="#" hx-get="/tests" hx-target="#content" hx-on:click="updateSortState(event, '5')">
                                Duration <i class="fas fa-sort"></i>
                            </a>
                        </th>
                        <th class="px-6 text-center">
                            <a href="#" hx-get="/tests" hx-target="#content" hx-on:click="updateSortState(event, '6')">
                                Set <i class="fas fa-sort"></i>
                            </a>
                        </th>
                        <th class="px-6 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="testTableBody" class="text-gray-600 text-sm">
                    <!-- Rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Ensure the script is executed only once (event listener is attached and constants are declared only once)
    if (!window.scriptExecutedOnce) {
        window.scriptExecutedOnce = true;

        document.body.addEventListener('htmx:load', function () {

            // Function to restore tests tab state (testtype dropdown, sort) and trigger HTMX request
            function restoreState() {
                const dropdown = document.getElementById('testtype-dropdown');
                if (!dropdown) return;

                const storedTesttype = sessionStorage.getItem('selectedTesttype');

                if (storedTesttype && dropdown.value !== storedTesttype) {
                    // Set the dropdown value
                    dropdown.value = storedTesttype;
                    updateSortIcons(sessionStorage.getItem(TESTS_SORT_COLUMN), sessionStorage.getItem(TESTS_SORT_ORDER));

                    // Trigger native change event which should activate HTMX
                    htmx.trigger(dropdown, 'change');
                }
            }

            restoreState();
        });

        const TESTS_SORT_COLUMN = "testsSortColumn";
        const TESTS_SORT_ORDER = "testsSortOrder";

        function updateSortState(event, column) {
            // Retrieve previous sort state from sessionStorage
            let previousColumn = sessionStorage.getItem(TESTS_SORT_COLUMN);
            let previousOrder = sessionStorage.getItem(TESTS_SORT_ORDER);

            let newOrder = "asc"; // Default to ascending order
            if (previousColumn === column) {
                newOrder = previousOrder === "asc" ? "desc" : "asc";
            }

            // Store new state
            sessionStorage.setItem(TESTS_SORT_COLUMN, column);
            sessionStorage.setItem(TESTS_SORT_ORDER, newOrder);
        }

        function updateSortIcons(column, order) {
            // Reset all icons
            document.querySelectorAll("th i.fas").forEach(icon => {
                icon.classList.remove("fa-sort-up", "fa-sort-down");
                icon.classList.add("fa-sort");
            });

            // Find the correct header and update its icon
            document.querySelectorAll("th").forEach(th => {
                let link = th.querySelector("a");
                if (link && link.getAttribute("hx-on:click")?.includes(column)) {
                    let icon = th.querySelector("i.fas");
                    if (icon) {
                        icon.classList.remove("fa-sort");
                        icon.classList.add(order === "asc" ? "fa-sort-up" : "fa-sort-down");
                    }
                }
            });
        }

        document.body.addEventListener('htmx:configRequest', function (event) {
            if (event.detail.path === "/api/tests") {
                // Get sessionStorage values
                let sortColumn = sessionStorage.getItem(TESTS_SORT_COLUMN);
                let sortOrder = sessionStorage.getItem(TESTS_SORT_ORDER);
                if (sortColumn) {
                    // Add them to the request parameters
                    event.detail.parameters.sortColumn = sortColumn;
                    event.detail.parameters.sortOrder = sortOrder;
                }
            }
        });
    }
</script>