{{ define "content" }}
<h1 class="text-lg font-semibold">New Test</h1>
<div class="flex h-screen">
    <!-- Left Panel -->
    <div class="w-1/3 p-5 bg-white shadow overflow-auto">
        <!-- Filters -->
        <div class="grid grid-cols-2 gap-4">
            <!-- name attribute is used, because query parameters passed via http request can be 
                 identified by element names only. It is used in chapter_handler.go -->
            <select id="chapter-dropdown" name="chapter-dropdown" hx-ext="cascade-clear"
                class="p-2 border rounded w-full"
                hx-trigger="load, onLoaded from:(#curriculum-dropdown, #grade-dropdown, #subject-dropdown), change from:(#curriculum-dropdown, #grade-dropdown, #subject-dropdown)"
                hx-get="/api/chapters?view=dropdown"
                hx-include="#curriculum-dropdown, #grade-dropdown, #subject-dropdown">
                <option>Select Chapter</option>
            </select>
            <select id="topic-dropdown" name="topic-dropdown" hx-ext="cascade-clear" class="p-2 border rounded w-full"
                hx-get="/api/topics?view=dropdown" hx-trigger="change from:#chapter-dropdown"
                hx-include="#chapter-dropdown">
                <option>Select Topic</option>
            </select>
            <label class="font-semibold">Level</label>
            <label class="font-semibold">Problem Type</label>
            <select id="level-dropdown" name="level-dropdown" class="p-2 border rounded w-full">
                <option value="">All</option>
                <option value="easy">Easy</option>
                <option value="medium">Medium</option>
                <option value="difficult">Hard</option>
            </select>
            <select id="ptype-dropdown" name="ptype-dropdown" class="p-2 border rounded w-full">
                <option value="">All</option>
                <option value="single_answer">Single Answer</option>
                <option value="mcq_single_answer">Mcq Single Answer</option>
                <option value="mcq_multiple_answer">Mcq Multiple Answer</option>
                <option value="integer_type">Integer Type</option>
                <option value="matrix_match">Matrix Match</option>
                <option value="numerical_answer">Numerical Answer</option>
                <option value="comprehension_type">Comprehension Type</option>
            </select>
        </div>
        <!-- Questions List -->
        <div class="mt-6">
            <h2 class="text-lg font-semibold">Question Bank</h2>
            <table class="mt-3 w-full border text-left">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="p-2">Code</th>
                        <th class="p-2">Question</th>
                        <th class="p-2">Action</th>
                    </tr>
                </thead>
                <tbody id="question-bank" hx-ext="addSelectedIds" hx-get="/api/topic/problems"
                    hx-trigger="change from:(#topic-dropdown, #level-dropdown, #ptype-dropdown)"
                    hx-include="#topic-dropdown, #subject-dropdown, #level-dropdown, #ptype-dropdown">
                    <!-- Rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Right Panel -->
    <div class="flex-1 p-5 overflow-auto bg-gray-50">
        <div class="flex items-center gap-2">
            <input type="text" placeholder="Test Name" class="p-2 border rounded flex-1">
            <select class="p-2 border rounded flex-1">
                {{ template "test_type_options" . }}
            </select>
        </div>

        <h2 class="mt-4 text-lg font-semibold">Marking Scheme</h2>
        <div class="mt-2 grid grid-cols-4 gap-4 items-center">
            <label class="font-semibold">Award</label>
            <div class="flex items-center border rounded p-2 w-full">
                <span class="text-gray-500">+</span>
                <input type="number" class="ml-2 w-full border-none focus:ring-0" value="0">
            </div>
            <label class="font-semibold">Deduct</label>
            <div class="flex items-center border rounded p-2 w-full">
                <span class="text-gray-500">-</span>
                <input type="number" class="ml-2 w-full border-none focus:ring-0" value="0">
            </div>
        </div>

        <!-- Levels Table -->
        <table class="mt-4 w-full border text-center">
            <thead>
                <tr class="bg-gray-200">
                    <th class="p-2">Level 1</th>
                    <th class="p-2">Level 2</th>
                    <th class="p-2">Level 3</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="level-easy" class="p-2">0</td>
                    <td id="level-medium" class="p-2">0</td>
                    <td id="level-difficult" class="p-2">0</td>
                </tr>
            </tbody>
        </table>

        <!-- Questions Table -->
        <table class="mt-4 w-full border text-left">
            <thead>
                <tr class="bg-gray-200">
                    <th class="p-2">S.No</th>
                    <th class="p-2">Code</th>
                    <th class="p-2">Level</th>
                    <th class="p-2">Question</th>
                    <th class="p-2 text-center">+ve Marks</th>
                    <th class="p-2 text-center">-ve Marks</th>
                    <th class="p-2">Action</th>
                </tr>
            </thead>
            <tbody id="questions-table-body" name="questions-table-body">
            </tbody>
        </table>
        <div class="grid grid-cols-[auto_1fr_auto_1fr] items-center gap-x-4 mt-2">
            <label class="text-sm font-medium">Duration (mins):</label>
            <input type="number" class="w-1/4 border rounded p-2" placeholder="60">
            <label class="text-sm font-medium">Total Marks:</label>
            <div class="p-2">100</div>
        </div>
        <button class="mt-4 w-full px-4 py-2 bg-blue-500 text-white rounded">Save</button>
    </div>
</div>

<script>
    htmx.defineExtension('cascade-clear', {
        onEvent: function (name, event) {
            if (name === "htmx:afterSwap") {

                const targetId = event.detail.target.id;
                // Reset topic dropdown to default if afterSwap event is received for chapter-dropdown
                if (targetId === "chapter-dropdown") {
                    const topicDropdown = document.getElementById('topic-dropdown');
                    if (topicDropdown) {
                        topicDropdown.innerHTML = '<option>Select Topic</option>';
                    }
                }

                // Clear problem list
                const problemList = document.getElementById('question-bank');
                if (problemList) {
                    problemList.innerHTML = '';
                }
            }
        }
    });

    htmx.defineExtension('addSelectedIds', {
        onEvent: function (name, evt) {
            if (name === "htmx:configRequest") {
                // add already selected problem ids in parameters
                const selectedIds = Array.from(document.querySelectorAll("#questions-table-body tr[id^='problem-']"))
                    .map(row => row.id.replace("problem-", ""));
                evt.detail.parameters["selected-ids"] = selectedIds.join(",");
            }
        }
    });

    function removeQuestionFromTest(btn) {
        // Remove problem row from the DOM
        const problemRow = btn.closest("tr");
        const prevRow = problemRow.previousElementSibling;
        const prevPrevRow = prevRow.previousElementSibling;
        let nextRow = problemRow.nextElementSibling;
        problemRow.remove();

        const dataset = btn.dataset;
        const subject = problemRow.dataset.subject;
        const subtype = problemRow.dataset.subtype;
        const tableBody = document.getElementById("questions-table-body");

        // Remove subtype header if no more problems of that subtype under same subject remain
        const remainingSubtypeProblems = tableBody.querySelectorAll(`tr[data-subject="${subject}"][data-subtype="${subtype}"]`);
        if (remainingSubtypeProblems.length === 0) {
            prevRow.remove();

            // Remove subject header if no more problems of that subject remain
            const remainingSubjectProblems = tableBody.querySelectorAll(`tr[data-subject="${subject}"]`);
            if (remainingSubjectProblems.length === 0) {
                prevPrevRow.remove();
            }
        }

        // Update serial numbers of all rows following removed row, skipping colspan header rows
        while (nextRow) {
            const firstTd = nextRow.querySelector("td");
            if (!firstTd.hasAttribute("colspan")) {
                firstTd.textContent = parseInt(firstTd.textContent - 1);
            }
            nextRow = nextRow.nextElementSibling;
        }

        // Decrement count in levels table
        decrementLevelCount(dataset.difficulty);

        // Refresh left panel
        const topicDropdown = document.getElementById("topic-dropdown");
        htmx.trigger(topicDropdown, "change");
    }

    function decrementLevelCount(difficulty) {
        const levelCell = document.getElementById(`level-${difficulty}`);
        levelCell.textContent = Math.max(0, parseInt(levelCell.textContent) - 1)
    }

    function handleEditableChips(e) {
        const editor = e.currentTarget;
        const selection = window.getSelection();
        const range = selection.getRangeAt(0);

        // Only handle Enter, Comma, or Space
        if (['Enter', ',', ' '].includes(e.key)) {
            e.preventDefault();

            // Get and trim the typed value
            const textNode = range.startContainer;
            let value = textNode.textContent.trim();

            // Remove the typed text
            textNode.textContent = '';

            // Get all existing chips in the same editor
            const existingMarks = Array.from(editor.querySelectorAll('.chip')).map(chip => chip.textContent.trim());

            // Validate and check duplicates
            if (value && /^\d+$/.test(value) && !existingMarks.includes(value)) {
                // Create chip element
                const chip = document.createElement('span');
                chip.className = 'chip';
                chip.contentEditable = 'false';
                chip.textContent = value;

                // Insert chip at cursor
                range.insertNode(chip);
                range.insertNode(document.createTextNode('\u00A0'));

                // Move cursor after the inserted chip
                const newRange = document.createRange();
                newRange.setStartAfter(chip.nextSibling || chip);
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);
            }
        }
    }

    function focusEditable(containerDiv) {
        const editor = containerDiv.querySelector('[contenteditable="true"]');
        editor.focus();
    }
</script>
{{ end }}